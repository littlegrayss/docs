<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信小程序双线程架构 | littlegrayss </title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/docs/favicon.ico">
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/docs/assets/css/0.styles.e01616c5.css" as="style"><link rel="preload" href="/docs/assets/js/app.09402c9e.js" as="script"><link rel="preload" href="/docs/assets/js/6.72c49ee7.js" as="script"><link rel="preload" href="/docs/assets/js/1.7e5ccb3e.js" as="script"><link rel="preload" href="/docs/assets/js/19.e8279f16.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.959dae65.js"><link rel="prefetch" href="/docs/assets/js/11.5113035a.js"><link rel="prefetch" href="/docs/assets/js/12.3f4ad253.js"><link rel="prefetch" href="/docs/assets/js/13.11e2aa18.js"><link rel="prefetch" href="/docs/assets/js/14.3e6818bf.js"><link rel="prefetch" href="/docs/assets/js/15.2cf7c923.js"><link rel="prefetch" href="/docs/assets/js/16.64282791.js"><link rel="prefetch" href="/docs/assets/js/17.2aa777a2.js"><link rel="prefetch" href="/docs/assets/js/18.bc4c79cb.js"><link rel="prefetch" href="/docs/assets/js/20.10ed9479.js"><link rel="prefetch" href="/docs/assets/js/21.1fcf1ad4.js"><link rel="prefetch" href="/docs/assets/js/22.2cd3380c.js"><link rel="prefetch" href="/docs/assets/js/23.82d5d9c2.js"><link rel="prefetch" href="/docs/assets/js/24.d096eb0a.js"><link rel="prefetch" href="/docs/assets/js/3.46063223.js"><link rel="prefetch" href="/docs/assets/js/4.2b85ad7a.js"><link rel="prefetch" href="/docs/assets/js/5.3f4c4b31.js"><link rel="prefetch" href="/docs/assets/js/7.cac8a0fe.js"><link rel="prefetch" href="/docs/assets/js/8.b3f31c7b.js"><link rel="prefetch" href="/docs/assets/js/9.91faaa99.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.e01616c5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">littlegrayss </span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/accumulation/" class="nav-link router-link-active">
  技术积累
</a></li><li class="dropdown-item"><!----> <a href="/docs/lifeThinking/" class="nav-link">
  生活感悟
</a></li><li class="dropdown-item"><!----> <a href="/docs/translation/" class="nav-link">
  翻译
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/accumulation/" class="nav-link router-link-active">
  技术积累
</a></li><li class="dropdown-item"><!----> <a href="/docs/lifeThinking/" class="nav-link">
  生活感悟
</a></li><li class="dropdown-item"><!----> <a href="/docs/translation/" class="nav-link">
  翻译
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>微信小程序双线程架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/accumulation/mini-program/Technology-Architecture.html#背景" class="sidebar-link">背景</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/accumulation/mini-program/Technology-Architecture.html#双线程架构" class="sidebar-link">双线程架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/accumulation/mini-program/Technology-Architecture.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/docs/accumulation/mini-program/Technology-Architecture.html#优点" class="sidebar-link">优点</a></li><li class="sidebar-sub-header"><a href="/docs/accumulation/mini-program/Technology-Architecture.html#不足" class="sidebar-link">不足</a></li></ul></li><li><a href="/docs/accumulation/mini-program/Technology-Architecture.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="微信小程序双线程架构"><a href="#微信小程序双线程架构" class="header-anchor">#</a> 微信小程序双线程架构</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>微信目标是为了连接一切。订阅号推出连接了用户与内容，服务号推出是为了连接用户与服务，但没用达到预期。</p> <p>微信在2013年专门拆分出一个服务号出来，其定位就是提供服务的平台。与公众号不同，服务号提供了更多的接口能力，例如获取用户信息、模版消息、微信支付等。这一点跟现在的小程序有点类似。</p> <blockquote><p>&quot;公众号的本意不是为了媒体，我们的本意不是传播内容，我们要提供服务，是为了提供服务，但服务号没有达到预期，我们在讨论一个新的形态，叫应用号。平时不发东西，他安静的存在在那，低频的需求不需要安装App，微信尝试让更多App以轻量便捷的形态在微信中存在，就是应用号。&quot;——张小龙</p></blockquote> <p>张小龙推出应用号，也就是小程序的时候说过，小程序有4个特性：无须安装、触手可及、用完即走、无须卸载。本质上是一个提供服务的工具。</p> <p>一个运行在微信上轻量便捷的工具，我们可以提炼出几点技术上的要求：</p> <ol><li>安全，易于管控</li> <li>渲染快、加载快</li> <li>独立于微信客户端来迭代</li> <li>开发成本低</li> <li>能调用微信的接口</li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>假设你是一名架构师，你会如何设计小程序的技术架构呢？</p></div> <h2 id="双线程架构"><a href="#双线程架构" class="header-anchor">#</a> 双线程架构</h2> <p>想一下为什么小程序不直接用浏览器的线程模型，而要搞一套新的呢？</p> <ul><li>web的体验相对较差，受限于设备性能和网络速度，有个较长的白屏时间。</li> <li>为了安全考虑，小程序不希望开发者能获取<code>dom</code>对象，因为这会带来很大的安全风险。</li></ul> <p>微信肯定不希望小程序能够威胁微信客户端本身的安全。设想一下，把微信比作CodePen、JSFiddler的平台，用户可以在上面随意编写代码并执行，小程序就是用户编写的代码，为了避免平台因为用户编写的代码而挂掉，要用什么样的技术方案去实现呢？</p> <h3 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h3> <p>小程序框架系统分为两部分：逻辑层（App Service）和 视图层（View）。小程序的页面渲染和业务逻辑是隔离的，目的是为了安全与管控。</p> <ol><li><p>逻辑层
逻辑层运行JS脚本。每个小程序只有一个逻辑线程。因为与渲染层隔离，逻辑层是接触不到dom的，所以小程序本身是不支持获取<code>window</code>和<code>document</code>对象的。这种情况有点类似<code>web worker</code>。</p></li> <li><p>渲染层
小程序各个界面被管理在一个页面栈中，界面相关的任务都在webview线程里执行，通过逻辑层代码去控制渲染哪些页面。一个小程序会有多个页面，所以渲染层会包含多个webview线程。</p></li></ol> <p>webKit里，webCore和JSCore执行在一个线程里，并且会相互阻塞，小程序逻辑层的代码执行不会阻塞渲染层的渲染逻辑，页面更流畅。</p> <p>为什么说分成两个隔离的线程可以安全呢？
逻辑层操作不了渲染层意味着开发者不能随意地跳转网页，改变界面上的任意内容。不能获取页面的任何内容，包括用户的敏感数据。能够避免XSS类的安全漏洞。</p> <p>既然逻辑层与渲染层不在同一个线程，相互之间是独立的，数据不能共享。要组成一个页面或者页面要更新，就需要两个线程的数据传递。</p> <p>两个线程之间是通过客户端进行中转通信的，逻辑层与客户端，渲染层与客户端的通信是通过注入一个原生方法，封装成WeiXinJSBridge，类似jsBridge。开发者不需要理解Android和ios的差异，这些底层框架已经封装好了。</p> <p>在我们知道两个线程是怎么通信之后，再来了解下线程之间通信的内容是什么。</p> <p>小程序更新 UI 的方式与MVVM 框架类似，既然不能操作dom，那就用virtual DOM的方式，通过diff方法来最小化比较与修改</p> <ol><li>渲染层把wxml生成一个virtual DOM的js对象，并进行渲染。</li> <li>逻辑层调用<code>setData</code>，更新数据到渲染层。</li> <li>渲染层对需要更新的数据进行diff，得到差异，然后把差异应用到真实的dom中，从而更新页面。</li></ol> <p>逻辑层调用<code>setData</code>的过程，就是逻辑层与渲染层通信的过程：</p> <ol><li>当开发者调用<code>setData</code> API的时候，底层会使用<code>JSON.stringify</code>处理数据，一些不可序列化的数据将会被移除</li> <li>逻辑层会将数据发送给渲染层，同步更新页面中的<code>data</code>数据，这样开发者可以在调用<code>setData</code>之后，从<code>this.data</code>中获取到变更后的最新数据</li> <li>数据的传输还需要通过Native进行中转，因此不能实时地到达渲染层，所以<code>setData</code>函数将数据从逻辑层发送到渲染层是异步的。如果我们需要知道页面渲染完毕，可以在调用<code>setData</code>的时候传入<code>callback</code>回调进行监听。</li></ol> <p><img src="http://img.littlegrayss.com/84og9toabm" alt=""></p> <p><code>setData</code>不是每次调用都立即进行通信，因为每次通信都要通过客户端进行，多次通信会造成效率低下，小程序是用一个同步队列，来保证消息的有序，同时一次通信会发送多个<code>setData</code>。</p> <p>所以到这里我们就能理解为什么官方不建议这么做：</p> <ol><li><code>setData</code>传递大量的新数据。数据的传输会经历跨线程传输和脚本编译的过程，当数据量过大，会增加脚本编译的执行时间，占用 WebView JS 线程。</li> <li>频繁的执行<code>setData</code>操作。
<ul><li>页面渲染结果有一定的延时。</li> <li>用户触发页面事件时，因 WebView JS 线程忙碌，用户事件未能及时的传输到逻辑层而导致反馈延迟。</li></ul></li></ol> <p>但是有些场景我们不得不需要频繁的交互，比如点击、输入。</p> <p>一次点击会导致四次通信，一次输入也需要4次通信。如果输入20个字，就需要80次通信。在频繁交互的场景会导致卡顿。</p> <ol><li>渲染层 -&gt; Native(点击事件)</li> <li>Native -&gt; 逻辑层(点击事件)</li> <li>逻辑层 -&gt; Native(setData)</li> <li>Native -&gt; 渲染层(setData)</li></ol> <p>为了应对这些场景，小程序也引入了原生组件，原生组件可以直接与逻辑层通信。避免了setData，能节省交互过程的通信次数和webview的计算与渲染工作。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li>一个小程序只有一个逻辑线程，即使切换了页面，在同一个页面的非data变量也会保存在内存中，非data变量不会在页面销毁的时候跟着销毁，一直保存在内存中，直到小程序被关闭。data的变量会随着页面注销而销毁。</li> <li>每个页面都是一个单独的WebView线程，但每个小程序只有一个逻辑线程。但是由于小程序逻辑层有模块化的能力，每个页面都有单独的作用域，不用文件或页面的变量不会相互影响。</li> <li>一个小程序里逻辑线程是共享的，业务代码还是执行在同一个上下文里，即使页面跳转了，跳转前的逻辑还会继续执行，很可能会多次跳转、重定向，参数丢失导致页面白屏</li></ol></div> <h3 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h3> <ol><li>使用 Webview 渲染 UI、使用类似Web Worker 的独立线程运行逻辑，既能够像 Web 一样将资源托管在云端，更新独立；同时又能够保证足够好的安全性和性能。</li> <li>jscore 阻塞期间用户依然可以跟 webview 进行交互。（但比较有限）</li> <li>所有的页面、组件逻辑都在一个线程里，比较好做状态共享。在传统的浏览器网页开发时，如果涉及到跨页面通信，往往要用到 <code>postMessage()</code> 这种异步接口，一个页面的 js 不能同步调用另一个页面的逻辑。在小程序里是可以的，由于都在一个线程里，你完全可以在一个 Page 实例里找到另一个 Page 实例，页面间互操作。</li></ol> <h3 id="不足"><a href="#不足" class="header-anchor">#</a> 不足</h3> <ol><li>业务逻辑跟渲染层天然隔离，造成通信开销大、延迟高等问题。小程序的长列表、手势跟随交互、Canvas渲染的体验都不算好。</li> <li>很多API都是异步的，需要改变编写习惯，把有前后逻辑关系的写在异步回调里。因为逻辑层和渲染层不是一个线程，通信有延迟，做同步的话逻辑层不就老是卡住了，所以很多接口都是异步的。</li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>小程序双线程设计有效地保证了安全和管控，能够避免XSS攻击，同时js加载不会阻塞页面渲染。也因为原生组件和微信提供的api，能有类似原生的交互体验。开发成本也相对较低，拥有与web一样的更新迭代能力。只是同时因为双线程的设计，通信过程不可避免地有一些问题。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.09402c9e.js" defer></script><script src="/docs/assets/js/6.72c49ee7.js" defer></script><script src="/docs/assets/js/1.7e5ccb3e.js" defer></script><script src="/docs/assets/js/19.e8279f16.js" defer></script>
  </body>
</html>
